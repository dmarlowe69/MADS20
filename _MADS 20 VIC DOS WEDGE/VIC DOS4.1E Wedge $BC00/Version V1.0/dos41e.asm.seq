;*********************************;;       DOS 4.1 DISK WEDGE;;      VERSION V4.1/071382;      BY BOB FAIRBAIRN;        COPYRIGHT 1982;  COMMODORE BUSINESS MACHINES;;  DOCUMENTED BY DENTON MARLOWE;;*********************************; VIC20 SYSTEM EQUATES;*********************************; BASIC TEXT AREA POINTERS;*********************************TXTTAB = $2B ;START OF BASIC TEXTVARTAB = $2D ;START OF BASIC STORAGE;*********************************; CHRGET ADDRESSES;*********************************CHRGET = $73 ;BASIC INPUT PROCESSORCHRGOT = $79 ;GET CURRENT CHARACTERTXTPTR = $7A ;CHRGET POINTER;*********************************; DISK I/O ADDRESS;*********************************STATUS = $90 ;KERNAL I/O STATUSFNLEN  = $B7 ;LENGTH OF FILENAMESA     = $B9 ;SECONDARY ADDRESSFA     = $BA ;DEVICE NUMBER;*********************************; TEMPOARY STORGAE;*********************************TEMP   = $9B ;TEMP0  = $B0 ;TEMP1  = $B1 ;;*********************************;;*********************************STACK  = $0100 ;6502 PROCESSOR STACK;*********************************; BASIC ROM ADDRESSES;*********************************BASSFT = $C480 ;RETURN TO BASICCHRGEC = $C48D ;CALL TO CHRGET FROM DIRECT MODELINPRT = $DDCD ;PRINT LINE NUMBERSAVET  = $E156 ;SAVE (PARAMS SET)CLOAD  = $E195CHRCPY = $E387 ;ROM COPY OF CHRGETWARMBS = $E467PRT    = $E742;*********************************; KERNAL JUMP TABLE;*********************************SECOND = $FF93TKSA   = $FF96ACPTR  = $FFA5CIOUT  = $FFA8UNTLK  = $FFABUNLSN  = $FFAELISTEN = $FFB1TALK   = $FFB4SETLFS = $FFBASETNAM = $FFBDOPEN   = $FFC0CLOSE  = $FFC3CLRCHN = $FFCCCHROUT = $FFD2LOAD   = $FFD5STOP   = $FFE1GETIN  = $FFE4;*********************************; ENTRY POINT;*********************************DOSWDG JMP START ;JMP PAST DATA;*********************************; DEVICE NUMBER;*********************************DEVICE .BYTE $AA;*********************************; LOAD/SAVE FLAG;*********************************LSFLAG .BYTE $AA;*********************************; WEDGE CHRGET PATCH;*********************************PATCH JMP WEDGE;*********************************; WEDGE ACTIVATION ROUTINE;; PATCH INTO CHRGET IN ZEROPAGE,; DEFINE USER'S CURRENT DEVICE; NUMBER, AND PRINT COPYRIGHT;;*********************************START LDX #$02     ;SET COUNTERS1    LDA PATCH,X  ;GET WEDGE      STA CHRGET,X ;STORE WEDGE      DEX          ;COUNT-1      BPL S1       ;LOOP 3 TIMES;      LDA FA       ;STORE CURRENT      STA DEVICE   ;DEVICE NUMBER;      JMP PRMESS   ;PRINT MESSAGE;********************************;;********************************WEDGE  INC TXTPTR       BNE XX0608       INC TXTPTR+1XX0608 STX TEMP       TSX ;********************************; CHECK WHERE WE WERE CALLED FROM; $C48D - 1 CALL TO CHRGET FROM; $C483 BASIC WARM START;********************************       LDA STACK+1,X       CMP #<CHRGEC-1 ;#$8C $C48C       BNE XX0648       LDA STACK+2,X       CMP #>CHRGEC   ;#$C4 $C48C       BNE XX0648     ;NOT OUR COMMAND;********************************; CHECK COMMAND;********************************       LDA TXTPTR       BNE XX0645  ;IF HIBYTE POINTER NON ZERO EXIT;       LDA TXTPTR+1       CMP #$02    ;DIRECT MODE       BNE XX0645  ;NO EXIT;       LDY #$00   ;SET INDEX=0       STY TEMP   ;SAVE;********************************; CHECK COMMAND; @ OR > OR /;********************************       LDA (TXTPTR),Y       CMP #$3E      ;'>'       BEQ XX063A;       CMP #$40      ;'@'       BEQ XX063A;       INY        STA TEMP       CMP #$2F      ;'/'       BEQ LOADER;       CMP #'%'       BEQ SAVER;       BNE XX0645;********************************;;********************************XX063A INY        LDA (TXTPTR),Y       BEQ XX066B;********************************; CHECK DIRECTORY COMMAND $;********************************       CMP #$24      ;'$'       BEQ LOADER;********************************; CHECK QUIT COMMAND Q;********************************       CMP #'Q'       BEQ QUIT;********************************; CHECK STATUS COMMAND ONLY;********************************       BNE XX064D;********************************; NO COMMAND - PASS BACK TO PROCESSING LOOP;********************************XX0645 JMP CHRGOT;********************************; EXIT;********************************QUIT   JMP QUITER;********************************; NOT OUR COMMAND ; RETURN TO CHRGET TO PROCESS COMMAND;********************************XX0648 LDX TEMP ; RECOVERY X REG       JMP CHRGOT;********************************; @ OR / READ DRIVE STATUS;********************************XX064D LDA DEVICE    ;#$08       JSR LISTEN       LDA #$0F+$60 ;SEC ORED WITH $60       STA SA       ;SET SECONDARY ADRS       JSR SECOND;XX0657 INC TXTPTR       LDY #$00       LDA (TXTPTR),Y       BEQ XX0665       JSR CIOUT       CLV        BVC XX0657;XX0665 JSR UNLSN       CLV        BVC XX068A;XX066B STY TXTPTR       LDA DEVICE  ;#$08       JSR TALK       LDA #$0F+$60 ;SEC ORED WITH $60       STA SA       ;SET SECONDARY ADRS       JSR TKSA;********************************; READ IN STATUS BYTES 00, OK,00,00;********************************XX0677 JSR ACPTR       CMP #$0D       BEQ XX0684       JSR PRT       CLV        BVC XX0677XX0684 JSR PRT       JSR UNTLKXX068A JMP CHRGOT;********************************; @$ OR /$ LIST DIRECTORY;********************************LOADER LDA #$00       STA LSFLAG       BEQ LOADS;SAVER  LDA #$FF       STA LSFLAG       ;LOADS  INY        LDA (TXTPTR),Y       BNE LOADS       DEY        TYA        LDX #$01       LDY #$02       JSR SETNAM;********************************       LDX DEVICE ;#$08       LDA TEMP       BNE LOADE1;       LDA #$0E       LDY #$60       JSR SETLFS;********************************       JSR OPEN;********************************       LDA DEVICE ;#$08       JSR TALK       LDA #$60       JSR TKSA       LDA #$00       STA STATUS       LDY #$03;********************************RFILNM STY FNLEN       JSR ACPTR       STA TEMP0       LDY STATUS       BNE XX06E1;********************************       JSR ACPTR       STA TEMP1       LDY STATUS       BNE XX06E1;********************************       LDY FNLEN       DEY        BNE RFILNM;********************************       LDX TEMP0       LDA TEMP1       JSR LINPRT       LDA #$20      ;' '       BNE XX06E5;********************************; LOAD FILE;********************************LOADE1 LDA LSFLAG       BNE SAVE1       JMP LOADIT;SAVE1  JMP SAVEIT;********************************; DONE.;********************************XX06E1 BNE ENDER;********************************; LOOP BACK TO READ MORE CHARACTERS;********************************XX06E3 BNE RFILNM;********************************;;********************************XX06E5 JSR CHROUTXX06E8 JSR ACPTR       LDX STATUS       BNE ENDER;********************************       CMP #$00       BEQ XX070B       JSR CHROUT       JSR STOP       BEQ ENDER;********************************       JSR GETIN       BEQ XX06E8       CMP #$20      ;' '       BNE XX06E8XX0704 JSR GETIN       BEQ XX0704       BNE XX06E8XX070B LDA #$0D       JSR CHROUT       LDY #$02       BNE XX06E3;********************************; DONE CLOSE CLEAR AND CLOSE CHANNEL;********************************ENDER  JSR CLRCHN ;CLEAT I/O CHANNELS       LDA #$0E   ;DRIVE CHANNEL       JSR CLOSE  ;CLOSE       PLA        ;PULL RTS ADDRESS       PLA       JMP WARMBS;********************************; /FILENAME - LOAD FILENAME;********************************LOADIT LDA #$0E       LDY #$00       JSR SETLFS       LDA #$00       LDX TXTTAB       LDY TXTTAB+1       JSR LOAD;********************************; BASIC CLEANUP AFTER LOAD;********************************       JMP CLOAD;********************************; %FILENAME - SAVE FILENAME;; EXECUTE RELOCATABLE SAVE;; THE CURRENT PROGRAM IS THE BASIC; TEXT AREA IS SAVED DISK WITH; USER GIVEN FILENAME. THE FILE; WILL BE A PRG (PROGRAM) TYPE.; THE SAVE COMMAND HAS THE FORM:;; %FILENAME;; THE DRIVE STATUS IS RETURNED; FOLLOWING THE SAVE;;********************************SAVEIT JSR SAVET;       LDA #$0D       JMP ENDER;       JSR PRT     ;PRINT CHAR       JMP ERROR   ;DISPLAY STATUS;*********************************; READ DISK ERROR STATUS (@);; COMMAND DEVICE TO TALK, USING; THE COMMAND CHANNEL (15),; INPUT BYTES FROM SERIAL BUS; AND PRINT THEM TO THE SCREEN; UNTILL A CARRIDGE RETURN IS; RECEIVED THEN UNTALK DEVICE;;*********************************ERROR LDA FA     ;GET DEVICE JSR TALK        ;TALK DEVICE LDA #$0F+$60    ;SEC+$60 STA SA          ;PLACE SEC JSR TKSA        ;SEND SEC;ERR1 JSR ACPTR   ;GET BYTE CMP #$0D        ;IS IF CR? BEQ ERR2        ;IF SO DONE JSR PRT         ;PRINT CHAR JMP ERR1        ;NEXT BYTE;ERR2 JSR PRT     ;PRINT CR JSR UNTLK       ;UNTALK DEVICEEEXIT JMP CHRGOT ;RETURN;********************************; PRINT STARTUP BANNER;********************************PRMESS LDX #$00STMSG  LDA BANNER,X       BEQ DONE       JSR CHROUT       INX       BNE STMSGDONE   RTS;********************************; STARTUP BANNER;********************************BANNER .BYTE $93 ; CLEAR SCREEN.BYTE $0D,$0D.BYTE '   VIC  DOS MANAGER',$0D.BYTE '    V4.1/071382',$0D,$0D.BYTE '  (C) 1982 COMMODORE',$0D.BYTE '   BUSINESS MACHINES',$0D,$00;*********************************BYE .BYTE 'BYE',$0D,$00;*********************************; DISABLE WEDGE (@Q);; REMOVE WEDGE FROM CHRGET BY; COPYING OVER THREE BYTE PATCH; WITH CORRECT BYTES FROM ROM;;*********************************QUITER LDX #$02        ;SET COUNTERROM    LDA CHRCPY,X    ;GET ROM BYTE       STA CHRGET,X    ;PUT IN CHRGET       DEX             ;COUNT-1       BPL ROM         ;MOVE 3 BYTES;             LDX #BYE-BANNER       JSR STMSG;      JMP BASSFT      ;BACK TO BASIC;********************************.END