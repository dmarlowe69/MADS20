;*********************************;;       DOS 4.1E DISK WEDGE;;      VERSION V4.1/071382;      BY BOB FAIRBAIRN;        COPYRIGHT 1982;  COMMODORE BUSINESS MACHINES;;  DOCUMENTED BY DENTON MARLOWE;;********************************; EXTERNAL ADDRESS EQUATES;********************************PRTLIN=$DDCDCLOAD =$E195WARMBS=$E467KCHROT=$E742;********************************; KERNAL ROM EQUATES;********************************SAVET  = $E156 ;SAVE (PARAMS SET);********************************; EXTERNAL ADDRESS EQUATES;********************************SECOND = $FF93TKSA   = $FF96ACPTR  = $FFA5CIOUT  = $FFA8UNTLK  = $FFABUNLSN  = $FFAELISTEN = $FFB1TALK   = $FFB4SETLFS = $FFBASETNAM = $FFBDOPEN   = $FFC0CLOSE  = $FFC3CLRCHN = $FFCCCHROUT = $FFD2LOAD   = $FFD5STOP   = $FFE1GETIN  = $FFE4;********************************; CHRGET EQUATES;********************************RCHRGT = $79 ;JUMP BACK INTI CHRGETTXTPTR = $7A ;CHRGET POINTER;*********************************; DISK I/O ADDRESS;*********************************STATUS = $90 ;KERNAL I/O STATUSPRTY   = $9B ;USED FOR TEMPORARY STORAGEFNLEN  = $B7 ;LENGTH OF FILENAMESA     = $B9 ;SECONDARY ADDRESSFA     = $BA ;DEVICE NUMBER;*********************************;;*********************************STACK  = $0100 ;6502 PROCESSOR STACK;*********************************; BASIC ROM ADDRESSES;*********************************BASSFT = $C480 ;RETURN TO BASICCHRGEC = $C48D ;CALL TO CHRGET FROM DIRECT MODECHRCPY = $E387 ;ROM COPY OF CHRGET;********************************; INITIZATION;********************************START LDA FA       ;STORE CURRENT      STA DEVICE   ;DEVICE NUMBER;      JMP PRMESS   ;PRINT MESSAGE;********************************;;********************************WEDGE  INC TXTPTR       BNE XX0608       INC TXTPTR+1XX0608 STX PRTY       TSX ;********************************; CHECK WHERE WE WERE CALLED FROM; $C48D - 1 CALL TO CHRGET FROM; $C483 BASIC WARM START;********************************       LDA STACK+1,X       CMP #<CHRGEC-1 ;#$8C $C48C       BNE XX0648       LDA STACK+2,X       CMP #>CHRGEC ;#$C4       BNE XX0648;********************************; CHECK COMMAND;********************************       LDA TXTPTR       BNE XX0645  ;IF HIBYTE POINTER NON ZERO EXIT;       LDA TXTPTR+1       CMP #$02    ;DIRECT MODE       BNE XX0645  ;NO EXIT;       LDY #$00   ;SET INDEX=0       STY PRTY   ;SAVE;********************************; CHECK COMMAND; @ OR > OR /;********************************       LDA (TXTPTR),Y       CMP #$3E      ;'>'       BEQ XX063A;       CMP #$40      ;'@'       BEQ XX063A;       INY        STA PRTY;       CMP #$2F      ;'/'       BEQ LOADER;       CMP #'%'       BEQ SAVER;       BNE XX0645;********************************;;********************************XX063A INY        LDA (TXTPTR),Y       BEQ XX066B;********************************; CHECK DIRECTORY COMMAND $;********************************       CMP #$24      ;'$'       BEQ XX068D;********************************; CHECK QUIT COMMAND Q;********************************       CMP #'Q'       BEQ QUIT;********************************; CHECK STATUS COMMAND ONLY;********************************       BNE XX064D;********************************; NO COMMAND - PASS BACK TO PROCESSING LOOP;********************************XX0645 JMP RCHRGT;********************************; EXIT;********************************QUIT   JMP QUITER;********************************; NOT OUR COMMAND ; RETURN TO CHRGET TO PROCESS COMMAND;********************************XX0648 LDX PRTY ; RECOVERY X REG       JMP RCHRGT;********************************; @ OR / READ DRIVE STATUS;********************************XX064D LDA #$08       JSR LISTEN       LDA #$6F       JSR SECOND;XX0657 INC TXTPTR       LDY #$00       LDA (TXTPTR),Y       BEQ XX0665       JSR CIOUT       CLV        BVC XX0657;XX0665 JSR UNLSN       CLV        BVC XX068A;XX066B STY TXTPTR       LDA #$08       JSR TALK       LDA #$6F       JSR TKSA;********************************; READ IN STATUS BYTES 00, OK,00,00;********************************XX0677 JSR ACPTR       CMP #$0D       BEQ XX0684       JSR KCHROT       CLV        BVC XX0677;XX0684 JSR KCHROT       JSR UNTLKXX068A JMP RCHRGT;********************************; @$ OR /$ LIST DIRECTORY;********************************LOADER LDA #$00       STA LSFLAG       BEQ XX068D;SAVER  LDA #$FF       STA LSFLAG       ;********************************; @$ OR /$ LIST DIRECTORY;********************************XX068D INY        LDA (TXTPTR),Y       BNE XX068D       DEY        TYA        LDX #$01       LDY #$02       JSR SETNAM;********************************       LDX #$08       LDA PRTY       BNE XX06DF;       LDA #$0E       LDY #$60       JSR SETLFS;********************************       JSR OPEN;********************************       LDA #$08       JSR TALK       LDA #$60       JSR TKSA       LDA #$00       STA STATUS       LDY #$03;********************************RFILNM STY $B7       JSR ACPTR       STA $B0       LDY STATUS       BNE XX06E1;********************************       JSR ACPTR       STA $B1       LDY STATUS       BNE XX06E1;********************************       LDY $B7       DEY        BNE RFILNM;********************************       LDX $B0       LDA $B1       JSR PRTLIN       LDA #$20      ;' '       BNE XX06E5;********************************; LOAD/SAVE FILE;********************************XX06DF LDA LSFLAG       BNE SAVE1       JMP LOADIT;SAVE1  JMP SAVEIT;********************************; DONE.;********************************XX06E1 BNE ENDER;********************************; LOOP BACK TO READ MORE CHARACTERS;********************************XX06E3 BNE RFILNM;********************************;;********************************XX06E5 JSR CHROUTXX06E8 JSR ACPTR       LDX STATUS       BNE ENDER;********************************       CMP #$00       BEQ XX070B       JSR CHROUT       JSR STOP       BEQ ENDER;********************************       JSR GETIN       BEQ XX06E8       CMP #$20      ;' '       BNE XX06E8XX0704 JSR GETIN       BEQ XX0704       BNE XX06E8XX070B LDA #$0D       JSR CHROUT       LDY #$02       BNE XX06E3;********************************; DONE CLOSE CLEAR AND CLOSE CHANNEL;********************************ENDER  JSR CLRCHN ;CLEAR I/O CHANNELS       LDA #$0E   ;DRIVE CHANNEL       JSR CLOSE  ;CLOSE       PLA        ;PULL RTS ADDRESS       PLA       JMP WARMBS;********************************; /FILENAME - LOAD FILENAME;********************************LOADIT LDA #$0E       LDY #$00       JSR SETLFS       LDA #$00       LDX VARTOP       LDY VARTOP+1       JSR LOAD;********************************; BASIC CLEANUP AFTER LOAD;********************************       JMP CLOAD;********************************; %FILENAME - SAVE FILENAME;; EXECUTE RELOCATABLE SAVE;; THE CURRENT PROGRAM IS THE BASIC; TEXT AREA IS SAVED DISK WITH; USER GIVEN FILENAME. THE FILE; WILL BE A PRG (PROGRAM) TYPE.; THE SAVE COMMAND HAS THE FORM:;; %FILENAME;; THE DRIVE STATUS IS RETURNED; FOLLOWING THE SAVE;;********************************SAVEIT JSR SAVET;       LDA #$0D       JMP ENDER;       JSR KCHROT     ;PRINT CHAR       JMP ERROR   ;DISPLAY STATUS;*********************************; READ DISK ERROR STATUS (@);; COMMAND DEVICE TO TALK, USING; THE COMMAND CHANNEL (15),; INPUT BYTES FROM SERIAL BUS; AND PRINT THEM TO THE SCREEN; UNTILL A CARRIDGE RETURN IS; RECEIVED THEN UNTALK DEVICE;;*********************************ERROR LDA FA     ;GET DEVICE JSR TALK        ;TALK DEVICE LDA #$0F+$60    ;SEC+$60 STA SA          ;PLACE SEC JSR TKSA        ;SEND SEC;ERR1 JSR ACPTR   ;GET BYTE CMP #$0D        ;IS IF CR? BEQ ERR2        ;IF SO DONE JSR KCHROT         ;PRINT CHAR JMP ERR1        ;NEXT BYTE;ERR2 JSR KCHROT     ;PRINT CR JSR UNTLK       ;UNTALK DEVICEEEXIT JMP RCHRGT ;RETURN;********************************; PRINT STARTUP BANNER;********************************PRMESS LDX #$00STMSG  LDA BANNER,X       BEQ DONE       JSR CHROUT       INX       BNE STMSGDONE   RTS;********************************; STARTUP BANNER;********************************BANNER .BYTE $93 ; CLEAR SCREEN.BYTE $0D,$0D.BYTE '   VIC  DOS MANAGER',$0D.BYTE '    V4.1/071382',$0D,$0D.BYTE '  (C) 1982 COMMODORE',$0D.BYTE '   BUSINESS MACHINES',$0D,$00;*********************************BYE .BYTE 'BYE',$0D,$00;*********************************; DEVICE NUMBER;*********************************DEVICE .BYTE $AA;*********************************; LOAD/SAVE FLAG;*********************************LSFLAG .BYTE $AA;*********************************; DISABLE WEDGE (@Q);; REMOVE WEDGE FROM CHRGET BY; COPYING OVER THREE BYTE PATCH; WITH CORRECT BYTES FROM ROM;;*********************************QUITER LDX #$02        ;SET COUNTERROM    LDA CHRCPY,X    ;GET ROM BYTE       STA ZCHRGT,X    ;PUT IN CHRGET       DEX             ;COUNT-1       BPL ROM         ;MOVE 3 BYTES;             LDX #BYE-BANNER       JSR STMSG;      JMP BASSFT      ;BACK TO BASIC;********************************.END