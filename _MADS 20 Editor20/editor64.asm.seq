;*********************************;;         EDITOR6464;      EDITOR.C64 V072882; EDITOR FOR ASSEMBLER SOURCE FILES;       BASIC V2 EXTENSION; (C) 1982 BY COMMODORE MACHINES;;  DOCUMENTED BY DENTON MARLOWE;********************************; EXTERNAL ADDRESS EQUATES;********************************; ZERO PAGE;********************************LINNUM = $14 ;INTEGER LINE NUMBER VALUEINDEX  = $22 ;BASIC TEMPORAY STORAGETXTTAB = $2B ;START OF BASIC RAM AREAVARTAB = $2D ;START OF BASIC VARABLE AREAEXTTAB = $5F ;APPLICATION COPY OF VARTABOLDLIN = $3B ;PREVIOUS BASIC LINE NUMBERINPPTR = $43 ;POINTER TO SOURCE OF GET,READ OR INPUTTXTPTR = $7A ;POINTER TO CHAR IN CHARGET ROUTINECHRMOD = $8A ;HOOK LOCATION INTO CHRGETFNADR  = $BB ;POINTER TO FILENAME;********************************; PAGE ZERO EQUATES;********************************STATUS = $90 ;KERNAL I/O STATUSFNLEN  = $B7 ;LENGTH OF FILENAME;********************************; BASIC EQUATES;********************************STACK = $0100;********************************; BASIC EQUATES;********************************BASBUF=$0200;********************************; BASIC EQUATES;********************************READY  = $A474 ; VIC20 = $C474CHRLOP = $A48D ; VIC20 = $C48DINDEL  = $A4A2 ; VIC20 = $C4A2MAINE  = $A52A ; VIC20 = $C52ALINKPG = $A533 ; VIC20 = $C533FNDLIN = $A613 ; VIC20 = $C613CLRENT = $A659 ; VIC20 = $C659LINGET = $A96B ; VIC20 = $C96BPRINTE = $AAD7 ; VIC20 = $CAD7ANDORE = $AEFD ; VIC20 = $CEFDSYTERR = $AF08 ; VIC20 = $CF08SGNENT = $BC49 ; VIC20 = $DC49LINPRT = $BDCD ; VIC20 = $DDCDFOUT   = $BDDD ; VIC20 = $DDDD;********************************; KERNAL EQUATES;********************************LSVPAR = $E1E6 ; VIC20 = $E1F3CKCOMA = $E20E ; VIC20 = $E20BEDNAME = $E257 ; VIC20 = $E254;********************************; KERNAL EQUATES;********************************SETLFS = $FFBASETNAM = $FFBDOPEN   = $FFC0CLOSE  = $FFC3CHKIN  = $FFC6CHKOUT = $FFC9CLRCHN = $FFCCCHRIN  = $FFCFCHROUT = $FFD2GETIN  = $FFE4SETTMO = $FFA2;********************************; EDITOR20 ENTRY POINT;********************************EDITOR =*;********************************; SET BASIC LAST LINE EXECUTED TO ZERO;********************************       LDA #$00     ;NULL       STA OLDLIN   ;$3B       STA OLDLIN+1 ;$3C;********************************; DISPLAY STARTUP BANNER;********************************       LDX #$00     ;ZERO OFFSET INTO TEXT       JSR PRTXT    ;PRINT STARTUP MESSAGE;********************************; MODIFIY END OF CHRGET ROUTINE; TO POINT TO EDITOR64 HANDLER; AND ON KILL RESET TO DEFAULT;********************************       ;LDA #$4C      ;'L'       ;BIT $60A9XXCC0B .BYTE $A9 ; LDA #$4CXXCC0C .BYTE $4CXXCC0D .BYTE $2CKILL   .BYTE $A9 ; LDA #$60XXCC0F .BYTE $60;       STA CHRMOD       LDA #<XXC02C ;#$2C       STA CHRMOD+1       LDA #>XXC02C ;$C0       STA CHRMOD+2       JMP XXC329;********************************; SAVE REGISTERS;********************************SAVREG STA SAVA       PHP        PLA        STA SAVP       STX SAVX       STY SAVY       RTS ;********************************; CHECK CALLING LOOP - DIRECT MODE ONLY; VIC = $C48D-1 C64 = $A48D-1;********************************XXC02C JSR SAVREG       TSX        LDA STACK+1,X       CMP #<CHRLOP-1 ;#$8C       BNE XXC03E       LDA STACK+2,X       CMP #>CHRLOP ;#$A4       BEQ XXC04D;********************************; RESTORE REGISTERS;********************************XXC03E LDY SAVY       LDX SAVX       LDA SAVP       PHA       LDA SAVA       PLP       RTS;********************************;;********************************XXC04D LDA SAVP       LSR A       BCC XXC0A0       LDX #$00       STX XXC63F       DEX        INX XXC05A LDY TXTPTRXXC05C LDA BASBUF,Y       SEC        SBC CMDTAB,X       BEQ XXC079       CMP #$80       BEQ XXC07D       INC XXC63FXXC06C INX        LDA CMDTAB-1,X       BPL XXC06C       LDA CMDTAB,X       BNE XXC05A       BEQ XXC03EXXC079 INX        INY        BNE XXC05CXXC07D STY TXTPTR       LDA XXC63F       ASL A       TAX        LDA VECTOR+1,X       PHA        LDA VECTOR,X       PHA        JSR XXC03E       JMP $0073;********************************;;********************************AUTO   JSR LINGET       LDA LINNUM       STA OLDLIN       LDA LINNUM+1       STA OLDLIN+1       JMP XXC329;********************************;;********************************XXC0A0 PLA        PLA        JSR XXC03E       JSR LINGET       BEQ XXC0E1       LDA OLDLIN       ORA OLDLIN+1       BEQ XXC0E1       LDA LINNUM       CLC        ADC OLDLIN       STA $63       LDA LINNUM+1       ADC OLDLIN+1       STA $62       LDX #$90       SEC        JSR SGNENT       JSR FOUT       LDX #$00       LDA #$20      ;' '       STA $0277,X       INX XXC0CE LDA $0100,X       BEQ XXC0D9       STA $0277,X       INX        BNE XXC0CEXXC0D9 LDA #$20      ;' '       STA $0277,X       INX        STX $C6XXC0E1 JSR XXC20B       JMP INDEL ; VIC  $C4A2 C64 = $A4A2;********************************;;********************************NUMBER BEQ XXC12B       JSR LINGET       JSR FNDLIN       JSR ANDORE       JSR LINGET       LDA LINNUM       STA FNADR       LDA LINNUM+1       STA FNADR+1       JSR ANDORE       JSR LINGETXXC103 JSR XXC2CA       BEQ XXC128       JSR XXC2C0       CLC        LDA FNADR       JSR XXC2BC       ADC LINNUM       STA FNADR       LDA FNADR+1       JSR XXC2BC       ADC LINNUM+1       STA FNADR+1XXC11E JSR XXC2CA       BNE XXC11E       JSR XXC2C0       BNE XXC103XXC128 JMP XXC329;********************************;;********************************XXC12B JSR PRINTE       JSR SETXAB; SET POINTER TO FILE NAME       LDA #$E8       STA FNADR       LDA #$03       STA FNADR+1;********************************;SET CURRENT LINE TO 10 ;********************************       LDA #$0A       STA LINNUM       LDA #$00       STA LINNUM+1       JMP XXC103;********************************; LOAD SOURCE FILE AS TEXT;********************************GET    JSR GETFIL       JSR CHKIN       LDA STATUS       BEQ XXC151       JMP PFILER;********************************; LOAD SOURCE FILE AS TEXT;********************************XXC151 LDA #$01       JSR XXC2B6XXC156 JSR CHRIN       CMP #$0D       BEQ XXC166       JSR XXC2BC       LDA STATUS       BNE XXC184       BEQ XXC156XXC166 JSR XXC19E       JSR XXC2CD       CMP #$01       BNE XXC178       JSR XXC19E       JSR XXC19B       BNE XXC180XXC178 JSR XXC2C0       LDA #$00       JSR XXC2BCXXC180 LDA STATUS       BEQ XXC151XXC184 TYA        JSR XXC2B6       LDA EXTTAB       STA VARTAB       LDA EXTTAB+1       STA VARTAB+1       JSR CLRCHN       LDA #$08       JSR CLOSE       JMP XXC12B;********************************;;********************************XXC19B JSR XXC19EXXC19E LDA EXTTAB       BNE XXC1A4       DEC EXTTAB+1XXC1A4 DEC EXTTAB       RTS ;********************************; PUT/CPUT ; SAVE A FILE OR PART OF A FILE; TO FLOPPY DISK;********************************CPUT   LDX #$00       .BYTE $2CPUT    LDX #$FF;       STX FILEXT       JSR XXC24F;       JSR CHKOUT       LDA STATUS       BEQ XXC1CB       JMP PFILER;********************************;;********************************XXC1BC LDA #$0D       JSR CHROUT       LDA STATUS       BEQ XXC1C8       JMP PFILER;********************************;;********************************XXC1C8 JSR XXC2C0XXC1CB JSR XXC2CA       BEQ XXC1D8       LDX FILEXT       JSR XXC481       BCS XXC1E7XXC1D8 JSR CLRCHN       LDA #$08       JSR CLOSE       JMP XXC329;********************************;;********************************XXC1E3 TYA        JSR CHROUTXXC1E7 JSR XXC2CA       TAY        BEQ XXC1BC       CMP #$20      ;' '       BNE XXC1F9       TXA        BMI XXC1E3       BNE XXC1E7       INX        BNE XXC1E3XXC1F9 CMP #OLDLIN      ;';'       BEQ XXC201       CMP #$27      ;'''       BNE XXC203XXC201 LDX #$FFXXC203 TXA        BMI XXC1E3       LDX FILEXT       BEQ XXC1E3XXC20B LDX #$FF       LDY #$00XXC20F INX        LDA BASBUF,X       CMP #$20      ;' '       BEQ XXC20F;********************************;;********************************       .BYTE $24;********************************;;********************************XXC218 INX        LDA BASBUF,X       CMP #$30      ;'0'       BCC XXC224       CMP #$3A      ;':'       BCC XXC218XXC224 LDA BASBUF,X       CMP #$20      ;' '       BNE XXC22C       INX XXC22C LDA BASBUF,X       BEQ XXC23A       AND #$7F       STA BASBUF,Y       INX        INY        BNE XXC22CXXC23A STA BASBUF,Y       INY        INY        STA BASBUF,Y       INY        INY        INY        RTS ;********************************; READ IN FILENAME;********************************GETNAM LDX #$00        STX STATUS       STX FNLEN;       JMP EDNAME ;VIC = $E254 C64 = $E257;********************************; OPEN SOURCE FILE OF FLOPPY DISK;********************************XXC24F JSR GETNAM       LDY #$00XXC254 LDA (FNADR),Y       STA (VARTAB),Y       INY        CPY FNLEN       BNE XXC254       LDX #$04XXC25F LDA FILEXT,X       STA (VARTAB),Y       INY        DEX        BNE XXC25F       STY FNLEN       JSR $0079       BEQ XXC272       JSR CKCOMAXXC272 JSR XXC452;********************************; ;********************************OPNAM  JSR LSVPAR;       LDA #$08       TAY        LDX $BA       JSR SETLFS;       LDA FNLEN       LDX VARTAB       LDY VARTAB+1       JSR SETNAM;       JSR OPEN       LDA STATUS       BEQ FILOK       CMP #$40      ;'@'       BEQ FILOK       JMP PFILER;********************************; LOAD X WITH FILE NUMBER;********************************FILOK  LDX #$08       RTS ;********************************; PARSE IN GET FILE COMMAND LINE;********************************GETFIL JSR GETNAM       JSR $0079       BEQ XXC2A5       JSR CKCOMAXXC2A5 JSR LINGET       JSR FNDLIN       LDA FNADR       LDY FNADR+1       STA VARTAB       STY VARTAB+1       JMP OPNAM;********************************;;********************************XXC2B6 JSR XXC2B9XXC2B9 JSR XXC2BCXXC2BC LDY #$00       STA (EXTTAB),YXXC2C0 INC EXTTAB       BNE XXC2C6       INC EXTTAB+1XXC2C6 RTS ;********************************;;********************************       JSR XXC2CAXXC2CA JSR XXC2C0XXC2CD LDY #$00       LDA (EXTTAB),Y       RTS ;********************************; LOAD POINTER TO START OF TEXT ARE; BY USING POINTER TO START OF BASIC;********************************SETXAB LDA TXTTAB       STA EXTTAB       LDA TXTTAB+1       STA EXTTAB+1       RTS ;********************************;;********************************XXC2DB JMP SYTERR ; C64 = $AF08;********************************;;********************************DELETE BEQ XXC2DB       JSR XXC452       LDA EXTTAB       LDX EXTTAB+1       STA INDEX+2       STX INDEX+3       JSR FNDLIN       BCC XXC2FE       LDY #$01       LDA (EXTTAB),Y       BEQ XXC2FE       TAX        DEY        LDA (EXTTAB),Y       STA EXTTAB       STX EXTTAB+1XXC2FE LDA INDEX+2       SEC        SBC EXTTAB       TAX        LDA INDEX+3       SBC EXTTAB+1       TAY        BCS XXC329       TXA        CLC        ADC VARTAB       STA VARTAB       TYA        ADC VARTAB+1       STA VARTAB+1       LDY #$00XXC318 LDA (EXTTAB),Y       STA (INDEX+2),Y       INY        BNE XXC318       INC EXTTAB+1       INC INDEX+3       LDA VARTAB+1       CMP INDEX+3       BCS XXC318;********************************;;********************************XXC329 JSR LINKPG       LDA INDEX       LDX INDEX+1       CLC        ADC #$02       STA VARTAB       BCC XXC338       INX XXC338 STX VARTAB+1       JSR CLRENT       JMP READY;********************************;;********************************CHANGE STA XXC63F       LDX #$00       STX $33       JSR XXC437       LDX #$02       STX $49       BNE XXC357FIND   STA XXC63F       LDX #$00       STX $49XXC357 JSR XXC437       JSR $0073       BEQ XXC362       JSR ANDOREXXC362 JSR XXC452       JSR PRINTE       BNE XXC375XXC36A INY        TYA        CLC        ADC EXTTAB       STA EXTTAB       BCC XXC375       INC EXTTAB+1XXC375 JSR XXC2CA       BEQ XXC37F       JSR XXC481       BCS XXC382XXC37F JMP MAINE;********************************;;********************************XXC382 STY XXC640XXC385 INC XXC640       LDY XXC640       LDX $31       LDA $32       STA SAVAXXC392 LDA (EXTTAB),Y       BEQ XXC36A       CMP BASBUF,X       BNE XXC385       INX        INY        DEC SAVA       BNE XXC392       DEY        STY XXC63F       STY SAVX       LDA $49       BEQ XXC413       JSR XXC495       LDA $34       SEC        SBC $32       STA SAVP       BEQ XXC3E7XXC3BA INY        BEQ XXC37F       LDA (EXTTAB),Y       BNE XXC3BA       CLC        TYA        ADC SAVP       CMP #$02       BCC XXC413       CMP #$4B      ;'K'       BCS XXC413       LDA SAVP       BPL XXC3D6       DEC SAVAXXC3D6 CLC        ADC XXC63F       STA SAVX       BCS XXC3E4       JSR XXC4CB       BEQ XXC3E7XXC3E4 JSR XXC4B1XXC3E7 LDA SAVX       SEC        SBC $34       TAY        INY        LDA $34       BEQ XXC404       STA SAVY       LDX $33XXC3F8 LDA BASBUF,X       STA (EXTTAB),Y       INX        INY        DEC SAVY       BNE XXC3F8XXC404 CLC        LDA VARTAB       ADC SAVP       STA VARTAB       LDA VARTAB+1       ADC SAVA       STA VARTAB+1XXC413 LDX INPPTR       LDA INPPTR+1       JSR LINPRT       LDY #$00       LDA #$20      ;' 'XXC41E JSR CHROUT       INY        BNE XXC427       JMP MAINE;********************************;;********************************XXC427 LDA (EXTTAB),Y       BNE XXC41E       JSR PRINTE       JSR XXC55A       LDY SAVX       JMP XXC382;********************************;;********************************XXC437 LDY TXTPTR       INY        STY $31,X       LDA #$00       STA $32,XXXC440 LDA BASBUF,Y       BEQ XXC45A       CMP XXC63F       BEQ XXC44F       INC $32,X       INY        BNE XXC440XXC44F STY TXTPTR       RTS ;********************************;;********************************XXC452 BCC XXC45D       BEQ XXC45D       CMP #$2D      ;'-'       BEQ XXC45DXXC45A JMP SYTERR ; C64 = $AF08;********************************;;********************************XXC45D JSR LINGET       JSR FNDLIN       JSR $0079       BEQ XXC474       CMP #$2D      ;'-'       BNE XXC45A       JSR $0073       JSR LINGET       BNE XXC45AXXC474 LDA LINNUM       ORA LINNUM+1       BNE XXC480       LDA #$FF       STA LINNUM       STA LINNUM+1XXC480 RTS ;********************************;;********************************XXC481 JSR XXC2CA       STA INPPTR       JSR XXC2CA       STA INPPTR+1       SEC        LDA LINNUM       SBC INPPTR       LDA LINNUM+1       SBC INPPTR+1       RTS ;********************************;;********************************XXC495 LDA EXTTAB       STA INDEX       LDA EXTTAB+1       STA INDEX+1       LDA VARTAB       STA INDEX+2       LDA VARTAB+1       STA INDEX+3       RTS ;********************************;;********************************XXC4A6 LDA INDEX       CMP INDEX+2       BNE XXC4B0       LDA INDEX+1       CMP INDEX+3XXC4B0 RTS ;********************************;;********************************XXC4B1 LDY XXC63F       INY        LDA (INDEX),Y       LDY SAVX       INY        STA (INDEX),Y       JSR XXC4A6       BNE XXC4C3       RTS ;********************************;;********************************XXC4C3 INC INDEX       BNE XXC4B1       INC INDEX+1       BNE XXC4B1XXC4CB LDY XXC63F       LDA (INDEX+2),Y       LDY SAVX       STA (INDEX+2),Y       JSR XXC4A6       BNE XXC4DB       RTS ;********************************;;********************************XXC4DB LDA INDEX+2       BNE XXC4E1       DEC INDEX+3XXC4E1 DEC INDEX+2       JMP XXC4CB;********************************;;********************************FORMAT JSR XXC452       BNE XXC4EEXXC4EB JSR XXC2C0XXC4EE JSR PRINTE       JSR XXC55A       JSR XXC2CA       BEQ XXC4FE       JSR XXC481       BCS XXC501XXC4FE JMP READY;********************************;;********************************XXC501 LDX INPPTR       LDA INPPTR+1       JSR LINPRT       LDA #$20      ;' '       JSR CHROUT       LDX #$00XXC50F JSR XXC2CA       BEQ XXC4EB       CMP #OLDLIN      ;';'       BEQ XXC550       CMP #$20      ;' '       BEQ XXC522       JSR CHROUT       INX        BNE XXC50FXXC522 CPX #$07       BCS XXC52C       JSR CHROUT       INX        BNE XXC522XXC52C JSR XXC2CA       BEQ XXC4EB       CMP #$20      ;' '       BEQ XXC52CXXC535 JSR CHROUT       INX        JSR XXC2CA       BEQ XXC4EB       CMP #OLDLIN      ;';'       BNE XXC535       PHA        LDA #$20      ;' 'XXC545 CPX #$17       BCS XXC54F       JSR CHROUT       INX        BNE XXC545XXC54F PLA XXC550 JSR CHROUT       JSR XXC2CA       BEQ XXC4EB       BNE XXC550XXC55A JSR GETIN       BEQ XXC57D       CMP #$03       BNE XXC569XXC563 JSR CLRENT       JMP READY;********************************;;********************************XXC569 CMP #$20      ;' '       BNE XXC57DXXC56D JSR GETIN       CMP #$20      ;' '       BEQ XXC56DXXC574 JSR GETIN       BEQ XXC574       CMP #$03       BEQ XXC563XXC57D RTS ;********************************; PRINT MESSAGE TO SCREEN; REG X CONTAINS INDEX INTO; MESSAGE TABLE;********************************PRTXT  STX FILEXT ;$C57EPRTNEX LDX FILEXT ;$C581       LDA MSGSTR,X       PHP        AND #$7F       JSR CHROUT       INC FILEXT       PLP        BPL PRTNEX       RTS ;********************************; PRINT 'FILE ERROR';********************************PFILER JSR CLRCHN       LDA #$08       JSR CLOSE       ;LDX #$4D      ;'M'       LDX #MSGERR-MSGSTR ;$4D	          JSR PRTXT       JMP READY;********************************; COMMANDS; AUTO; CHANGE ; CPUT; DELETE; FIND; FORMAT; GET; KILL; NUMBER; PUT;********************************CMDTAB .BYTE 'AUT' ;$C5A4       .BYTE $CF ;'O'+$80       .BYTE 'CHANG'       .BYTE $C5 ;'E'+$80       .BYTE 'CPU'       .BYTE $D4 ;'T'+$80       .BYTE 'DELET'       .BYTE $C5 ;'E'+$80       .BYTE 'FIN'       .BYTE $C4 ;'D'+$80       .BYTE 'FORMA'       .BYTE $D4 ;'T'+$80       .BYTE 'GE'       .BYTE $D4 ;'T'+$80       .BYTE 'KIL'       .BYTE $CC ;'L'+$80       .BYTE 'NUMBE'       .BYTE $D2 ;'R'+$80       .BYTE 'PU'       .BYTE $D4 ;'T'+$80;********************************;;********************************       .BYTE $00;**************************************; VECTOR TABLE - ADDRESS - 1;**************************************; AUTO;VECTOR .BYTE $91 ;XXC5D3;XXC5D4 .BYTE $C0 ;XXC3D4VECTOR  .WORD AUTO-1; CHANGE       ;.BYTE $3F       ;.BYTE $C3        .WORD CHANGE-1; CPUT       ;.BYTE $A6       ;.BYTE $C1       .WORD CPUT-1; DELETE       ;.BYTE $DD       ;.BYTE $C2       .WORD DELETE-1; FIND       ;.BYTE $4F       ;.BYTE $C3       .WORD FIND-1; FORMAT       ;.BYTE $E5       ;.BYTE $C4       .WORD FORMAT-1; GET       ;.BYTE $43       ;.BYTE $C1       .WORD GET-1; KILL       ;.BYTE $0D       ;.BYTE $C0       .WORD KILL-1; NUMBER       ;.BYTE $E6       ;.BYTE $C0       .WORD NUMBER-1; PUT       ;.BYTE $A9       ;.BYTE $C1       .WORD PUT-1;**************************************; MESSAGE TABLE;**************************************   MSGSTR .BYTE $0D ;$C5E7       .BYTE $0D       .BYTE '      COMMODORE 64 EDITOR V072982'       .BYTE $0D       .BYTE '(C) 1982 BY COMMODORE BUSINESS MACHINES'       .BYTE $0D       .BYTE $8D ; $0D WITH BIT 8 SETMSGERR .BYTE $0D       .BYTE 'FILE ERRO'       .BYTE $D2 ; $52 (R) WITH BIT 8 SET;**************************************   XXC63F .BYTE $00 ;XXC63FXXC640 .BYTE $00 ;XXC640SAVA   .BYTE $00 ;XXC641SAVP   .BYTE $00 ;XXC642SAVX   .BYTE $00 ;XXC643SAVY   .BYTE $00 ;XXC644FILEXT .BYTE $00 ;XXC645       .BYTE 'W,S,';********************************.END